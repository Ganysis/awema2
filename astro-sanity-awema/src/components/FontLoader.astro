---
export interface Props {
  fontFamily: string;
  fontWeights?: string[];
  subset?: string;
  display?: "auto" | "block" | "swap" | "fallback" | "optional";
}

const {
  fontFamily,
  fontWeights = ["400", "500", "600", "700"],
  subset = "latin",
  display = "swap"
} = Astro.props;

// Generate font URL with optimizations
const weights = fontWeights.join(";");
const fontUrl = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/ /g, "+")}:wght@${weights}&display=${display}&subset=${subset}`;

// Extract font name for CSS variable
const fontName = fontFamily.toLowerCase().replace(/ /g, "-");
---

<!-- Preload font CSS -->
<link
  rel="preload"
  href={fontUrl}
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
/>

<!-- Fallback for no JavaScript -->
<noscript>
  <link href={fontUrl} rel="stylesheet" />
</noscript>

<!-- Font loading optimization script -->
<script define:vars={{ fontFamily, fontUrl }}>
  // Font loading optimization with Font Face Observer pattern
  (function() {
    // Check if fonts are already loaded from cache
    if (sessionStorage.getItem('fontsLoaded')) {
      document.documentElement.classList.add('fonts-loaded');
      return;
    }

    // Create font face observer
    if ('fonts' in document) {
      Promise.all([
        document.fonts.load(`400 1em ${fontFamily}`),
        document.fonts.load(`700 1em ${fontFamily}`)
      ]).then(() => {
        document.documentElement.classList.add('fonts-loaded');
        sessionStorage.setItem('fontsLoaded', '1');
      }).catch(() => {
        // Fallback to system fonts if loading fails
        console.warn('Font loading failed, using fallback fonts');
      });
    }
  })();
</script>

<style define:vars={{ fontName, fontFamily }}>
  /* Font loading states */
  :root {
    --font-primary: var(--font-${fontName}, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif);
    --font-${fontName}: ${fontFamily};
  }

  /* Prevent FOUT (Flash of Unstyled Text) */
  html:not(.fonts-loaded) body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  html.fonts-loaded body {
    font-family: var(--font-primary);
  }

  /* Font smoothing for better rendering */
  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    font-synthesis: none;
  }

  /* Optimize font rendering on high-DPI screens */
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    body {
      -webkit-font-smoothing: subpixel-antialiased;
    }
  }
</style>