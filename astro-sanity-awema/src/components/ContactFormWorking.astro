---
// Formulaire de contact fonctionnel (basé sur /contact)
export interface Props {
  title?: string;
  submitText?: string;
  showMetier?: boolean;
}

const {
  title = "Demandez votre devis gratuit",
  submitText = "Envoyer ma demande",
  showMetier = true
} = Astro.props;
---

<div class="bg-white rounded-xl shadow-xl p-8 text-gray-900">
  <h3 class="text-2xl font-bold mb-6">{title}</h3>

  <form id="contact-form" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="prenom" class="form-label">Prénom <span class="text-red-500">*</span></label>
        <input
          id="prenom"
          name="prenom"
          class="form-input"
          placeholder="Jean"
          type="text"
          required
        />
      </div>
      <div>
        <label for="nom" class="form-label">Nom <span class="text-red-500">*</span></label>
        <input
          id="nom"
          name="nom"
          class="form-input"
          placeholder="Dupont"
          type="text"
          required
        />
      </div>
    </div>

    <div>
      <label for="entreprise" class="form-label">Nom de votre entreprise</label>
      <input
        id="entreprise"
        name="entreprise"
        class="form-input"
        placeholder="Plomberie Dupont"
        type="text"
      />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="email" class="form-label">Email <span class="text-red-500">*</span></label>
        <input
          id="email"
          name="email"
          class="form-input"
          placeholder="jean@exemple.fr"
          type="email"
          required
        />
      </div>
      <div>
        <label for="telephone" class="form-label">Téléphone <span class="text-red-500">*</span></label>
        <input
          id="telephone"
          name="telephone"
          class="form-input"
          placeholder="06 12 34 56 78"
          type="tel"
          required
        />
      </div>
    </div>

    {showMetier && (
      <div>
        <label for="metier" class="form-label">Votre métier</label>
        <select id="metier" name="metier" class="form-input">
          <option value="">Sélectionnez votre métier</option>
          <option value="plombier">Plombier</option>
          <option value="electricien">Électricien</option>
          <option value="menuisier">Menuisier</option>
          <option value="macon">Maçon</option>
          <option value="paysagiste">Paysagiste</option>
          <option value="peintre">Peintre</option>
          <option value="carreleur">Carreleur</option>
          <option value="chauffagiste">Chauffagiste</option>
          <option value="couvreur">Couvreur</option>
          <option value="serrurier">Serrurier</option>
          <option value="autre">Autre</option>
        </select>
      </div>
    )}

    <div>
      <label for="projet" class="form-label">Décrivez votre projet <span class="text-red-500">*</span></label>
      <textarea
        id="projet"
        name="projet"
        class="form-input"
        placeholder="J'aimerais un site vitrine moderne pour mon entreprise..."
        rows="4"
        required
      ></textarea>
    </div>

    <div class="flex items-center gap-3">
      <input type="checkbox" id="rgpd" name="rgpd" required class="w-4 h-4" />
      <label for="rgpd" class="text-sm text-gray-600">
        J'accepte que mes données soient utilisées pour me recontacter dans le cadre de ma demande. *
      </label>
    </div>

    <button
      type="submit"
      class="btn btn-primary w-full mt-6"
    >
      {submitText}
      <svg class="w-5 h-5 ml-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
      </svg>
    </button>
  </form>

  <div id="form-success" class="hidden mt-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
    <p class="font-semibold">Merci pour votre message !</p>
    <p>Nous vous recontacterons dans les 24h.</p>
  </div>
</div>

<script>
  document.getElementById('contact-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.innerHTML;

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    const formData = new FormData(form);
    const data = {
      name: `${formData.get('prenom')} ${formData.get('nom')}`,
      email: formData.get('email'),
      phone: formData.get('telephone'),
      service: formData.get('metier') || formData.get('type_site'),
      message: formData.get('projet') || formData.get('message')
    };

    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        // Redirection vers la page de remerciement (pour tracking Google Ads)
        window.location.href = '/merci';

        // Fallback si la redirection échoue
        setTimeout(() => {
          form.style.display = 'none';
          document.getElementById('form-success')?.classList.remove('hidden');
        }, 500);
        setTimeout(() => {
          form.style.display = 'block';
          form.reset();
          document.getElementById('form-success')?.classList.add('hidden');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }, 5000);
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      alert('Erreur lors de l\'envoi. Appelez-nous au 06.17.54.03.83');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });
</script>
