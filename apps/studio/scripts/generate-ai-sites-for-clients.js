const { PrismaClient } = require('@prisma/client');
const fs = require('fs');
const path = require('path');

const prisma = new PrismaClient();

// Helper function to generate unique block IDs
let blockCounter = 0;
const generateBlockId = (type) => {
  blockCounter++;
  return `${type}-${Date.now()}-${blockCounter}-${Math.random().toString(36).substr(2, 9)}`;
};

// Simulated AI Site Generator (since we can't import TypeScript modules directly)
const generateSiteFromFormData = (formData, businessType) => {
  const company = formData.businessName;
  const city = formData.city;
  
  // Generate pages based on business type
  const pages = [];
  
  // Homepage
  pages.push({
    id: 'home',
    name: 'Accueil',
    slug: '/',
    isHomePage: true,
    seo: {
      title: `${company} - ${getBusinessTitle(businessType)} √† ${city} | ${businessType === 'plombier' ? 'D√©pannage 24h/7j' : 'Devis gratuit'}`,
      description: `${company}, votre ${getBusinessTitle(businessType)} √† ${city}. ${formData.description || getDefaultDescription(businessType)}`,
      keywords: [`${getBusinessTitle(businessType)} ${city}`, `${businessType} ${city}`, 'devis gratuit', 'artisan qualifi√©']
    },
    blocks: [
      {
        id: generateBlockId('header'),
        type: 'header-v3-perfect',
        props: {
          variant: 'transparent-fixed',
          logoText: company,
          navigation: [
            { label: 'Accueil', href: '/' },
            { label: 'Services', href: '/services' },
            { label: '√Ä propos', href: '/about' },
            { label: 'Contact', href: '/contact' }
          ]
        }
      },
      {
        id: generateBlockId('hero'),
        type: 'hero-v3-perfect',
        props: {
          variant: businessType === 'plombier' ? 'centered-bold' : 'split-content',
          title: getHeroTitle(businessType, company, city),
          subtitle: getHeroSubtitle(businessType, formData),
          primaryButton: { 
            text: formData.emergency247 ? '‚òéÔ∏è Urgence 24h/7j' : 'Devis gratuit', 
            href: formData.emergency247 ? `tel:${formData.phone}` : '/contact' 
          },
          secondaryButton: { text: 'Nos services', href: '#services' },
          backgroundImage: `/images/${businessType}-hero.jpg`
        }
      },
      {
        id: generateBlockId('services'),
        type: 'services-v3-perfect',
        props: {
          variant: 'cards-hover',
          title: 'Nos Services',
          subtitle: `D√©couvrez l'ensemble de nos prestations de ${getBusinessTitle(businessType)}`,
          service1_name: getMainService(businessType, 1).name,
          service1_description: getMainService(businessType, 1).description,
          service1_price: getMainService(businessType, 1).price,
          service1_icon: getMainService(businessType, 1).icon,
          service2_name: getMainService(businessType, 2).name,
          service2_description: getMainService(businessType, 2).description,
          service2_price: getMainService(businessType, 2).price,
          service2_icon: getMainService(businessType, 2).icon,
          service3_name: getMainService(businessType, 3).name,
          service3_description: getMainService(businessType, 3).description,
          service3_price: getMainService(businessType, 3).price,
          service3_icon: getMainService(businessType, 3).icon
        }
      },
      {
        id: generateBlockId('features'),
        type: 'features-v3-perfect',
        props: {
          variant: 'grid-icons',
          title: 'Pourquoi nous choisir ?',
          feature1_title: `${formData.yearsExperience} ans d'exp√©rience`,
          feature1_description: `Fort de ${formData.yearsExperience} ann√©es d'expertise dans le ${getBusinessTitle(businessType)}`,
          feature1_icon: 'üèÜ',
          feature2_title: 'Devis gratuit',
          feature2_description: '√âtude personnalis√©e et chiffrage sans engagement',
          feature2_icon: 'üìã',
          feature3_title: 'Garantie qualit√©',
          feature3_description: 'Travaux garantis et assurance d√©cennale',
          feature3_icon: '‚úÖ',
          feature4_title: formData.emergency247 ? 'Urgence 24h/7j' : 'Intervention rapide',
          feature4_description: formData.emergency247 ? 'Disponible jour et nuit pour vos urgences' : 'R√©activit√© garantie pour tous vos projets',
          feature4_icon: formData.emergency247 ? 'üö®' : '‚ö°'
        }
      },
      {
        id: generateBlockId('testimonials'),
        type: 'testimonials-v3-perfect',
        props: {
          variant: 'carousel-modern',
          title: 'Ils nous font confiance',
          testimonial1_content: getTestimonial(businessType, 1),
          testimonial1_author: 'Marie L.',
          testimonial1_rating: 5,
          testimonial1_location: city,
          testimonial2_content: getTestimonial(businessType, 2),
          testimonial2_author: 'Jean-Pierre M.',
          testimonial2_rating: 5,
          testimonial2_location: city,
          testimonial3_content: getTestimonial(businessType, 3),
          testimonial3_author: 'Sophie D.',
          testimonial3_rating: 5,
          testimonial3_location: city
        }
      },
      {
        id: generateBlockId('cta'),
        type: 'cta-v3-perfect',
        props: {
          variant: 'gradient-waves',
          title: formData.emergency247 ? 'Besoin d\'une intervention urgente ?' : 'Pr√™t √† d√©marrer votre projet ?',
          subtitle: formData.emergency247 ? 'Nous intervenons 24h/24 et 7j/7' : 'Contactez-nous pour un devis gratuit',
          primaryButton: { 
            text: formData.emergency247 ? `‚òéÔ∏è ${formData.phone}` : 'Demander un devis', 
            href: formData.emergency247 ? `tel:${formData.phone}` : '/contact' 
          }
        }
      },
      {
        id: generateBlockId('footer'),
        type: 'footer-v3-perfect',
        props: {
          variant: 'modern-columns',
          companyName: company,
          description: formData.description || getDefaultDescription(businessType),
          phone: formData.phone,
          email: formData.email,
          address: `${city}, France`
        }
      }
    ]
  });

  // Service pages for each city
  formData.interventionCities.forEach(cityName => {
    pages.push({
      id: `${businessType}-${cityName.toLowerCase().replace(/\s+/g, '-')}`,
      name: `${getBusinessTitle(businessType)} ${cityName}`,
      slug: `/zones/${businessType}-${cityName.toLowerCase().replace(/\s+/g, '-')}`,
      seo: {
        title: `${getBusinessTitle(businessType)} ${cityName} - ${company} | Intervention rapide`,
        description: `${company} intervient √† ${cityName} pour tous vos besoins en ${getBusinessTitle(businessType)}. Devis gratuit, intervention rapide.`,
        keywords: [`${businessType} ${cityName}`, `artisan ${cityName}`, 'd√©pannage', 'urgence']
      },
      blocks: [
        {
          id: generateBlockId('header'),
          type: 'header-v3-perfect',
          props: {
            variant: 'transparent-fixed',
            logoText: company
          }
        },
        {
          id: generateBlockId('hero'),
          type: 'hero-v3-perfect',
          props: {
            variant: 'centered-simple',
            title: `Votre ${getBusinessTitle(businessType)} √† ${cityName}`,
            subtitle: `${company} - Intervention rapide et professionnelle`
          }
        },
        {
          id: generateBlockId('content'),
          type: 'content-v3-perfect',
          props: {
            variant: 'split-image',
            title: `${getBusinessTitle(businessType)} de proximit√© √† ${cityName}`,
            content: getLocalContent(businessType, cityName, company, formData.yearsExperience),
            imageUrl: `/images/${businessType}-work.jpg`,
            imagePosition: 'right'
          }
        },
        {
          id: generateBlockId('footer'),
          type: 'footer-v3-perfect',
          props: {
            variant: 'modern-columns',
            companyName: company
          }
        }
      ]
    });
  });

  // About page
  pages.push({
    id: 'about',
    name: '√Ä propos',
    slug: '/about',
    seo: {
      title: `√Ä propos - ${company} | ${getBusinessTitle(businessType)} √† ${city}`,
      description: `D√©couvrez ${company}, votre ${getBusinessTitle(businessType)} de confiance √† ${city}. ${formData.yearsExperience} ans d'exp√©rience.`
    },
    blocks: [
      {
        id: generateBlockId('header'),
        type: 'header-v3-perfect',
        props: { variant: 'transparent-fixed', logoText: company }
      },
      {
        type: 'hero-v3-perfect',
        props: {
          variant: 'centered-simple',
          title: `√Ä propos de ${company}`,
          subtitle: `${formData.yearsExperience} ans d'expertise en ${getBusinessTitle(businessType)}`
        }
      },
      {
        type: 'content-v3-perfect',
        props: {
          variant: 'timeline',
          title: 'Notre histoire',
          items: [
            {
              year: new Date().getFullYear() - parseInt(formData.yearsExperience),
              title: 'Cr√©ation de l\'entreprise',
              description: `Fondation de ${company} avec une vision claire : offrir des services de ${getBusinessTitle(businessType)} de qualit√©`
            },
            {
              year: new Date().getFullYear() - Math.floor(parseInt(formData.yearsExperience) / 2),
              title: 'Expansion',
              description: `D√©veloppement de notre √©quipe et √©largissement de notre zone d'intervention`
            },
            {
              year: new Date().getFullYear(),
              title: 'Aujourd\'hui',
              description: `Leader local avec ${formData.yearsExperience} ans d'exp√©rience et des milliers de clients satisfaits`
            }
          ]
        }
      },
      {
        id: generateBlockId('footer'),
        type: 'footer-v3-perfect',
        props: { variant: 'modern-columns', companyName: company }
      }
    ]
  });

  // Contact page
  pages.push({
    id: 'contact',
    name: 'Contact',
    slug: '/contact',
    seo: {
      title: `Contact - ${company} | ${getBusinessTitle(businessType)} √† ${city}`,
      description: `Contactez ${company} pour tous vos besoins en ${getBusinessTitle(businessType)}. Devis gratuit, intervention rapide √† ${city}.`
    },
    blocks: [
      {
        id: generateBlockId('header'),
        type: 'header-v3-perfect',
        props: { variant: 'transparent-fixed', logoText: company }
      },
      {
        id: generateBlockId('contact'),
        type: 'contact-v3-perfect',
        props: {
          variant: 'split-map',
          title: 'Contactez-nous',
          subtitle: 'Nous sommes √† votre √©coute pour tous vos projets',
          phone: formData.phone,
          email: formData.email,
          address: `${city}, France`,
          hours: formData.emergency247 ? '24h/24, 7j/7' : 'Lun-Ven: 8h-18h, Sam: 9h-12h',
          mapPosition: 'right'
        }
      },
      {
        id: generateBlockId('footer'),
        type: 'footer-v3-perfect',
        props: { variant: 'modern-columns', companyName: company }
      }
    ]
  });

  // Gallery page if selected
  if (formData.selectedPages?.includes('gallery')) {
    pages.push({
      id: 'gallery',
      name: 'R√©alisations',
      slug: '/realisations',
      seo: {
        title: `Nos r√©alisations - ${company} | ${getBusinessTitle(businessType)} √† ${city}`,
        description: `D√©couvrez les r√©alisations de ${company}, votre ${getBusinessTitle(businessType)} √† ${city}. Photos avant/apr√®s de nos chantiers.`
      },
      blocks: [
        {
          id: generateBlockId('header'),
          type: 'header-v3-perfect',
          props: { variant: 'transparent-fixed', logoText: company }
        },
        {
          id: generateBlockId('hero'),
          type: 'hero-v3-perfect',
          props: {
            variant: 'centered-simple',
            title: 'Nos r√©alisations',
            subtitle: 'D√©couvrez nos projets r√©cents'
          }
        },
        {
          id: generateBlockId('gallery'),
          type: 'gallery-v3-perfect',
          props: {
            variant: 'masonry-flow',
            title: 'Galerie de nos travaux',
            columnsDesktop: 3,
            columnsTablet: 2,
            columnsMobile: 1,
            enableLightbox: true,
            enableFilters: true,
            image1_src: `/images/${businessType}-project-1.jpg`,
            image1_title: getProjectTitle(businessType, 1),
            image1_category: 'recent',
            image2_src: `/images/${businessType}-project-2.jpg`,
            image2_title: getProjectTitle(businessType, 2),
            image2_category: 'renovation',
            image3_src: `/images/${businessType}-project-3.jpg`,
            image3_title: getProjectTitle(businessType, 3),
            image3_category: 'neuf',
            image4_src: `/images/${businessType}-project-4.jpg`,
            image4_title: getProjectTitle(businessType, 4),
            image4_category: 'recent',
            image5_src: `/images/${businessType}-project-5.jpg`,
            image5_title: getProjectTitle(businessType, 5),
            image5_category: 'renovation',
            image6_src: `/images/${businessType}-project-6.jpg`,
            image6_title: getProjectTitle(businessType, 6),
            image6_category: 'neuf'
          }
        },
        {
          id: generateBlockId('footer'),
          type: 'footer-v3-perfect',
          props: { variant: 'modern-columns', companyName: company }
        }
      ]
    });
  }

  // FAQ page if selected
  if (formData.selectedPages?.includes('faq')) {
    pages.push({
      id: 'faq',
      name: 'FAQ',
      slug: '/faq',
      seo: {
        title: `Questions fr√©quentes - ${company} | ${getBusinessTitle(businessType)} √† ${city}`,
        description: `FAQ de ${company}. Toutes les r√©ponses √† vos questions sur nos services de ${getBusinessTitle(businessType)} √† ${city}.`
      },
      blocks: [
        {
          id: generateBlockId('header'),
          type: 'header-v3-perfect',
          props: { variant: 'transparent-fixed', logoText: company }
        },
        {
          id: generateBlockId('hero'),
          type: 'hero-v3-perfect',
          props: {
            variant: 'centered-simple',
            title: 'Questions fr√©quentes',
            subtitle: 'Tout ce que vous devez savoir sur nos services'
          }
        },
        {
          id: generateBlockId('faq'),
          type: 'faq-v3-perfect',
          props: {
            variant: 'accordion-modern',
            title: 'FAQ',
            faq1_question: getFAQ(businessType, 1).question,
            faq1_answer: getFAQ(businessType, 1).answer,
            faq2_question: getFAQ(businessType, 2).question,
            faq2_answer: getFAQ(businessType, 2).answer,
            faq3_question: getFAQ(businessType, 3).question,
            faq3_answer: getFAQ(businessType, 3).answer,
            faq4_question: getFAQ(businessType, 4).question,
            faq4_answer: getFAQ(businessType, 4).answer,
            faq5_question: getFAQ(businessType, 5).question,
            faq5_answer: getFAQ(businessType, 5).answer
          }
        },
        {
          id: generateBlockId('footer'),
          type: 'footer-v3-perfect',
          props: { variant: 'modern-columns', companyName: company }
        }
      ]
    });
  }

  return {
    pages,
    theme: {
      colors: {
        primary: formData.colorScheme === 'predefined' ? getBusinessColors(businessType).primary : '#2563EB',
        secondary: formData.colorScheme === 'predefined' ? getBusinessColors(businessType).secondary : '#3B82F6',
        accent: formData.colorScheme === 'predefined' ? getBusinessColors(businessType).accent : '#EF4444'
      },
      typography: {
        fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, sans-serif"
      }
    },
    navigation: pages.map(p => ({
      label: p.name,
      href: p.slug,
      isActive: p.isHomePage
    })),
    settings: {
      siteName: company,
      favicon: `/favicon-${businessType}.ico`,
      logo: `/logo-${company.toLowerCase().replace(/[^a-z0-9]/g, '-')}.png`
    }
  };
};

// Helper functions
const getBusinessTitle = (type) => {
  const titles = {
    plombier: 'Plombier',
    electricien: '√âlectricien',
    menuisier: 'Menuisier',
    peintre: 'Peintre d√©corateur',
    macon: 'Ma√ßon'
  };
  return titles[type] || 'Artisan';
};

const getDefaultDescription = (type) => {
  const descriptions = {
    plombier: 'D√©pannage, installation et r√©novation plomberie. Intervention rapide, travail soign√©, devis gratuit.',
    electricien: 'Installation √©lectrique, mise aux normes, d√©pannage. √âlectricien certifi√©, intervention rapide.',
    menuisier: 'Menuiserie sur mesure, agencement int√©rieur, r√©novation. Artisan menuisier qualifi√©.',
    peintre: 'Peinture int√©rieure et ext√©rieure, d√©coration, ravalement. Peintre professionnel.',
    macon: 'Construction, r√©novation, extension. Ma√ßonnerie g√©n√©rale, gros ≈ìuvre, finitions.'
  };
  return descriptions[type] || 'Artisan qualifi√© pour tous vos travaux.';
};

const getHeroTitle = (type, company, city) => {
  const titles = {
    plombier: `Urgence Plomberie ${city} - Intervention en 30 minutes 24h/7j`,
    electricien: `Votre √âlectricien de Confiance √† ${city}`,
    menuisier: `L'art de la menuiserie √† ${city}`,
    peintre: `Donnez vie √† vos murs avec ${company}`,
    macon: `B√¢tissons vos projets ensemble √† ${city}`
  };
  return titles[type] || `${company} - Votre artisan √† ${city}`;
};

const getHeroSubtitle = (type, formData) => {
  const subtitles = {
    plombier: `${formData.businessName} - Votre expert plombier disponible 24h/7j`,
    electricien: '√âlectricien certifi√© pour tous vos travaux √©lectriques',
    menuisier: 'Cr√©ations sur mesure et r√©novation bois',
    peintre: 'Peinture et d√©coration int√©rieure',
    macon: 'Construction et r√©novation de qualit√©'
  };
  return subtitles[type] || formData.description;
};

const getMainService = (type, index) => {
  const services = {
    plombier: [
      { name: 'D√©bouchage canalisation', description: 'Intervention rapide pour d√©boucher vos canalisations', price: '√Ä partir de 89‚Ç¨', icon: 'üöø' },
      { name: 'Recherche de fuite', description: 'D√©tection pr√©cise sans destruction', price: '√Ä partir de 150‚Ç¨', icon: 'üíß' },
      { name: 'D√©pannage chauffe-eau', description: 'R√©paration et remplacement toutes marques', price: '√Ä partir de 120‚Ç¨', icon: 'üî•' }
    ],
    electricien: [
      { name: 'Mise aux normes √©lectriques', description: 'Mise en conformit√© compl√®te NFC 15-100', price: '√Ä partir de 1500‚Ç¨', icon: '‚ö°' },
      { name: 'Installation domotique', description: 'Maison connect√©e et intelligente', price: '√Ä partir de 2000‚Ç¨', icon: 'üè†' },
      { name: 'D√©pannage √©lectrique', description: 'Intervention rapide pour toute panne', price: '√Ä partir de 90‚Ç¨', icon: 'üîå' }
    ],
    menuisier: [
      { name: 'Cuisine sur mesure', description: 'Conception de cuisines personnalis√©es', price: '√Ä partir de 5000‚Ç¨', icon: 'üç≥' },
      { name: 'Escalier bois', description: 'Cr√©ation d\'escaliers design', price: '√Ä partir de 3500‚Ç¨', icon: 'üìê' },
      { name: 'Dressing sur mesure', description: 'Agencement optimal de vos espaces', price: '√Ä partir de 2000‚Ç¨', icon: 'üëî' }
    ],
    peintre: [
      { name: 'Peinture int√©rieure', description: 'Murs et plafonds, finitions parfaites', price: '√Ä partir de 25‚Ç¨/m¬≤', icon: 'üé®' },
      { name: 'Enduits d√©coratifs', description: 'B√©ton cir√©, stuc, tadelakt', price: '√Ä partir de 45‚Ç¨/m¬≤', icon: '‚ú®' },
      { name: 'Ravalement fa√ßade', description: 'R√©novation compl√®te de vos fa√ßades', price: 'Sur devis', icon: 'üè¢' }
    ],
    macon: [
      { name: 'Construction maison', description: 'Maisons individuelles cl√©s en main', price: '√Ä partir de 1200‚Ç¨/m¬≤', icon: 'üèóÔ∏è' },
      { name: 'Extension maison', description: 'Agrandissement de votre habitation', price: '√Ä partir de 1500‚Ç¨/m¬≤', icon: 'üìè' },
      { name: 'R√©novation compl√®te', description: 'Transformation totale de votre bien', price: 'Sur devis', icon: 'üî®' }
    ]
  };
  return services[type]?.[index - 1] || { name: 'Service', description: 'Description du service', price: 'Sur devis', icon: 'üõ†Ô∏è' };
};

const getTestimonial = (type, index) => {
  const testimonials = {
    plombier: [
      'Intervention tr√®s rapide suite √† une fuite d\'eau. Plombier professionnel et efficace. Je recommande vivement !',
      'Excellent travail pour le remplacement de ma chaudi√®re. Prix correct et travail soign√©.',
      'Disponible m√™me le dimanche pour une urgence. Service impeccable et tarifs transparents.'
    ],
    electricien: [
      'Mise aux normes de mon installation r√©alis√©e parfaitement. √âlectricien tr√®s comp√©tent.',
      'Installation de ma borne de recharge voiture √©lectrique nickel. Travail propre et rapide.',
      'D√©pannage efficace et explications claires. Un vrai professionnel !'
    ],
    menuisier: [
      'Cuisine sur mesure magnifique ! Le travail du bois est exceptionnel.',
      'Escalier r√©alis√© avec beaucoup de soin. Le r√©sultat d√©passe nos attentes.',
      'Dressing parfaitement adapt√© √† notre espace. Tr√®s satisfaits du r√©sultat.'
    ],
    peintre: [
      'Peinture de tout l\'appartement impeccable. Finitions parfaites !',
      'Enduit d√©coratif sublime dans notre salon. Un vrai artiste !',
      'Ravalement de fa√ßade r√©ussi. Notre maison a retrouv√© tout son √©clat.'
    ],
    macon: [
      'Extension de maison r√©alis√©e dans les d√©lais. Travail de qualit√©.',
      'Construction de notre maison parfaite. √âquipe s√©rieuse et professionnelle.',
      'R√©novation compl√®te r√©ussie. Nous sommes ravis du r√©sultat.'
    ]
  };
  return testimonials[type]?.[index - 1] || 'Excellent travail, je recommande !';
};

const getLocalContent = (type, city, company, years) => {
  return `Implant√©s √† ${city} depuis ${years} ans, nous connaissons parfaitement votre secteur et ses sp√©cificit√©s. ${company} intervient rapidement pour tous vos besoins en ${getBusinessTitle(type)}.

Notre √©quipe de professionnels qualifi√©s est √† votre service pour tous types d'interventions : d√©pannage urgent, installation, r√©novation ou entretien. Nous mettons un point d'honneur √† fournir un travail de qualit√©, dans le respect des normes en vigueur.

Que vous soyez un particulier ou un professionnel, nous adaptons nos interventions √† vos besoins sp√©cifiques. Devis gratuit et sans engagement, transparence des tarifs, respect des d√©lais : telles sont nos valeurs.`;
};

const getBusinessColors = (type) => {
  const colors = {
    plombier: { primary: '#2563EB', secondary: '#3B82F6', accent: '#EF4444' },
    electricien: { primary: '#F59E0B', secondary: '#FCD34D', accent: '#3B82F6' },
    menuisier: { primary: '#92400E', secondary: '#B45309', accent: '#059669' },
    peintre: { primary: '#8B5CF6', secondary: '#EC4899', accent: '#14B8A6' },
    macon: { primary: '#6B7280', secondary: '#DC2626', accent: '#F59E0B' }
  };
  return colors[type] || { primary: '#2563EB', secondary: '#3B82F6', accent: '#EF4444' };
};

const getFAQ = (type, index) => {
  const faqs = {
    plombier: [
      { question: 'Intervenez-vous en urgence le week-end ?', answer: 'Oui, nous sommes disponibles 24h/24 et 7j/7 pour toutes vos urgences plomberie.' },
      { question: 'Quels sont vos d√©lais d\'intervention ?', answer: 'Pour les urgences, nous intervenons en moins de 30 minutes. Pour les travaux planifi√©s, sous 24 √† 48h.' },
      { question: 'Proposez-vous des devis gratuits ?', answer: 'Oui, tous nos devis sont gratuits et sans engagement. Nous √©tablissons un devis d√©taill√© avant toute intervention.' },
      { question: '√ätes-vous assur√©s ?', answer: 'Oui, nous disposons d\'une assurance responsabilit√© civile professionnelle et d\'une garantie d√©cennale.' },
      { question: 'Quels moyens de paiement acceptez-vous ?', answer: 'Nous acceptons les esp√®ces, ch√®ques, cartes bancaires et virements.' }
    ],
    electricien: [
      { question: '√ätes-vous certifi√©s pour les installations √©lectriques ?', answer: 'Oui, nous sommes certifi√©s Qualifelec et RGE, garantissant la qualit√© de nos interventions.' },
      { question: 'R√©alisez-vous les mises aux normes √©lectriques ?', answer: 'Oui, nous r√©alisons la mise aux normes compl√®te de votre installation selon la norme NFC 15-100.' },
      { question: 'Installez-vous des bornes de recharge ?', answer: 'Oui, nous sommes certifi√©s IRVE pour l\'installation de bornes de recharge pour v√©hicules √©lectriques.' },
      { question: 'Proposez-vous un service de d√©pannage ?', answer: 'Oui, nous intervenons rapidement pour tout d√©pannage √©lectrique, m√™me en urgence.' },
      { question: 'D√©livrez-vous des attestations de conformit√© ?', answer: 'Oui, nous fournissons toutes les attestations n√©cessaires apr√®s nos interventions.' }
    ],
    menuisier: [
      { question: 'Travaillez-vous sur mesure ?', answer: 'Oui, toutes nos r√©alisations sont sur mesure et adapt√©es √† vos espaces et besoins.' },
      { question: 'Quelles essences de bois utilisez-vous ?', answer: 'Nous travaillons avec diverses essences : ch√™ne, h√™tre, fr√™ne, et des bois exotiques sur demande.' },
      { question: 'Proposez-vous la pose ?', answer: 'Oui, nous assurons la fabrication et la pose de tous nos ouvrages.' },
      { question: 'Quel est le d√©lai de fabrication ?', answer: 'Le d√©lai varie selon le projet, g√©n√©ralement entre 4 et 8 semaines apr√®s validation du devis.' },
      { question: 'Entretenez-vous vos r√©alisations ?', answer: 'Oui, nous proposons des contrats d\'entretien pour garantir la long√©vit√© de vos menuiseries.' }
    ],
    peintre: [
      { question: 'Prot√©gez-vous les meubles pendant les travaux ?', answer: 'Oui, nous prot√©geons soigneusement tous vos meubles et sols avant de commencer.' },
      { question: 'Utilisez-vous des peintures √©cologiques ?', answer: 'Oui, nous proposons une gamme de peintures √©cologiques sans COV.' },
      { question: 'R√©alisez-vous des enduits d√©coratifs ?', answer: 'Oui, nous ma√Ætrisons diff√©rentes techniques : b√©ton cir√©, stuc, tadelakt, etc.' },
      { question: 'Faites-vous les travaux de pr√©paration ?', answer: 'Oui, nous r√©alisons tous les travaux de pr√©paration n√©cessaires : rebouchage, pon√ßage, etc.' },
      { question: 'Garantissez-vous vos travaux ?', answer: 'Oui, tous nos travaux sont garantis 2 ans minimum.' }
    ],
    macon: [
      { question: 'R√©alisez-vous des extensions de maison ?', answer: 'Oui, nous r√©alisons tous types d\'extensions : lat√©rale, sur√©l√©vation, v√©randa ma√ßonn√©e.' },
      { question: 'Proposez-vous des constructions cl√©s en main ?', answer: 'Oui, nous g√©rons votre projet de A √† Z, de la conception √† la remise des cl√©s.' },
      { question: '√ätes-vous couverts par la garantie d√©cennale ?', answer: 'Oui, tous nos travaux sont couverts par notre assurance d√©cennale.' },
      { question: 'G√©rez-vous les d√©marches administratives ?', answer: 'Oui, nous vous accompagnons dans toutes les d√©marches : permis de construire, d√©clarations.' },
      { question: 'Travaillez-vous avec des architectes ?', answer: 'Oui, nous collaborons avec des architectes ou pouvons vous recommander des partenaires.' }
    ]
  };
  return faqs[type]?.[index - 1] || { question: 'Question ?', answer: 'R√©ponse d√©taill√©e.' };
};

const getProjectTitle = (type, index) => {
  const projects = {
    plombier: ['R√©novation salle de bain compl√®te', 'Installation chauffe-eau thermodynamique', 'Cr√©ation salle d\'eau', 'Remplacement tuyauterie', 'Installation adoucisseur', 'D√©bouchage complexe'],
    electricien: ['Mise aux normes pavillon', 'Installation domotique compl√®te', 'Tableau √©lectrique neuf', '√âclairage LED design', 'Borne recharge voiture', 'R√©novation √©lectrique appartement'],
    menuisier: ['Cuisine ch√™ne massif', 'Escalier contemporain', 'Biblioth√®que sur mesure', 'Dressing optimis√©', 'Parquet massif', 'Terrasse bois exotique'],
    peintre: ['R√©novation appartement haussmannien', 'B√©ton cir√© salon moderne', 'Ravalement fa√ßade maison', 'D√©coration chambre enfant', 'Peinture cage escalier', 'Enduit d√©coratif restaurant'],
    macon: ['Construction maison moderne', 'Extension salon 40m¬≤', 'Piscine et terrasse', 'R√©novation grange', 'Sur√©l√©vation pavillon', 'Mur de cl√¥ture design']
  };
  return projects[type]?.[index - 1] || `Projet ${index}`;
};

// Main function
async function generateAISitesForClients() {
  console.log('üöÄ G√©n√©ration des sites IA pour les 5 clients cr√©√©s...\n');

  // Get all demo clients
  const clients = await prisma.client.findMany({
    where: {
      email: {
        in: [
          'demo.plombier@awema.fr',
          'demo.electricien@awema.fr', 
          'demo.menuisier@awema.fr',
          'demo.peintre@awema.fr',
          'demo.macon@awema.fr'
        ]
      }
    },
    include: {
      projects: true
    }
  });

  const results = [];

  for (const client of clients) {
    console.log(`\nüìã G√©n√©ration pour : ${client.companyName}`);
    
    try {
      // Parse the tags to get businessType and formData
      const tags = JSON.parse(client.tags || '{}');
      const businessType = tags.businessType;
      const formData = tags.formData || {};
      
      if (!businessType) {
        throw new Error('BusinessType non trouv√© dans les tags');
      }

      // Get the project
      const project = client.projects[0];
      if (!project) {
        throw new Error('Aucun projet trouv√© pour ce client');
      }

      console.log(`   ‚è≥ G√©n√©ration du site (${businessType})...`);
      const startTime = Date.now();
      
      // Generate the site
      const generatedSite = generateSiteFromFormData(formData, businessType);
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2);
      console.log(`   ‚úÖ Site g√©n√©r√© en ${duration}s`);
      console.log(`      - ${generatedSite.pages.length} pages cr√©√©es`);
      console.log(`      - ${generatedSite.pages.reduce((sum, p) => sum + p.blocks.length, 0)} blocs configur√©s`);

      // Save the site data to the project
      await prisma.project.update({
        where: { id: project.id },
        data: {
          data: JSON.stringify(generatedSite),
          status: 'PUBLISHED',
          publishedAt: new Date()
        }
      });
      console.log(`   ‚úÖ Donn√©es sauvegard√©es dans le projet`);

      // Save to results
      results.push({
        client: client.companyName,
        clientId: client.id,
        projectId: project.id,
        businessType: businessType,
        url: `http://localhost:3000/editor/${project.id}`,
        previewUrl: `http://localhost:3000/preview/${project.id}`,
        pages: generatedSite.pages.length,
        blocks: generatedSite.pages.reduce((sum, p) => sum + p.blocks.length, 0),
        duration: duration,
        status: 'success'
      });

    } catch (error) {
      console.error(`   ‚ùå Erreur : ${error.message}`);
      results.push({
        client: client.companyName,
        error: error.message,
        status: 'error'
      });
    }
  }

  // Display summary
  console.log('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('              ‚ú® SITES G√âN√âR√âS PAR L\'IA                    ');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  results.forEach((result, index) => {
    if (result.status === 'success') {
      console.log(`‚úÖ ${index + 1}. ${result.client} (${result.businessType})`);
      console.log(`   üìé √âditeur: ${result.url}`);
      console.log(`   üëÅÔ∏è  Preview: ${result.previewUrl}`);
      console.log(`   üìÑ Pages: ${result.pages}`);
      console.log(`   üß© Blocs: ${result.blocks}`);
      console.log(`   ‚ö° G√©n√©r√© en: ${result.duration}s`);
      console.log(`   üîë Client ID: ${result.clientId}`);
      console.log(`   üîë Project ID: ${result.projectId}\n`);
    } else {
      console.log(`‚ùå ${index + 1}. ${result.client}`);
      console.log(`   Erreur: ${result.error}\n`);
    }
  });

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
  console.log('üéâ Les 5 sites de d√©monstration sont pr√™ts !');
  console.log('üìå Acc√©dez aux sites via les liens ci-dessus');
  console.log('üí° Utilisez l\'√©diteur pour personnaliser davantage');
  console.log('üöÄ D√©ployez sur Netlify en un clic depuis l\'√©diteur\n');

  // Save a detailed report
  const reportPath = path.join(__dirname, 'generated-sites-report.json');
  fs.writeFileSync(reportPath, JSON.stringify({
    generatedAt: new Date().toISOString(),
    totalSites: results.length,
    successCount: results.filter(r => r.status === 'success').length,
    results: results
  }, null, 2));
  
  console.log(`üìä Rapport d√©taill√© sauvegard√© : ${reportPath}\n`);

  await prisma.$disconnect();
}

// Execute
generateAISitesForClients().catch(async (error) => {
  console.error('Erreur fatale:', error);
  await prisma.$disconnect();
  process.exit(1);
});